<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuration Blender</title>
    <style>
        :root {
            --primary-color: #0071dc;
            --secondary-color: #004c91;
            --success-color: #2e7d32;
            --warning-color: #f57c00;
            --error-color: #d32f2f;
            --background-color: #f5f5f5;
            --card-background: #ffffff;
            --text-color: #333333;
            --border-color: #dddddd;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        .header {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .header-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-primary {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #003366;
        }

        .btn-secondary {
            background-color: white;
            color: var(--primary-color);
        }

        .btn-secondary:hover {
            background-color: #e3f2fd;
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background-color: #1b5e20;
        }

        .btn-danger {
            background-color: var(--error-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #b71c1c;
        }

        .btn-info {
            background-color: transparent;
            color: white;
            border: 1px solid white;
        }

        .btn-info:hover {
            background-color: rgba(255,255,255,0.1);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        .card {
            background-color: var(--card-background);
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 1.5rem;
        }

        .card h2 {
            color: var(--secondary-color);
            margin-bottom: 1rem;
            font-size: 1.2rem;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 0.5rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.3rem;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(0,113,220,0.2);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .checks-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            margin-bottom: 1rem;
        }

        .check-item {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .check-item:hover {
            background-color: #f0f0f0;
        }

        .check-item.selected {
            background-color: #e3f2fd;
            border-left: 3px solid var(--primary-color);
        }

        .check-item:last-child {
            border-bottom: none;
        }

        .check-info {
            flex: 1;
        }

        .check-name {
            font-weight: 500;
            font-size: 0.95rem;
        }

        .check-type {
            font-size: 0.8rem;
            color: #666;
        }

        .check-actions {
            display: flex;
            gap: 0.25rem;
        }

        .check-actions button {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
        }

        .json-preview {
            background-color: #1e1e1e;
            color: #d4d4d4;
            padding: 1rem;
            border-radius: 4px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.85rem;
            max-height: 500px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 8px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .modal-header h3 {
            color: var(--secondary-color);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }

        .close-btn:hover {
            color: #333;
        }

        .about-content {
            line-height: 1.8;
        }

        .about-content h4 {
            color: var(--primary-color);
            margin: 1rem 0 0.5rem 0;
        }

        .about-content p {
            margin-bottom: 1rem;
        }

        .author-info {
            background-color: #f5f5f5;
            padding: 1rem;
            border-radius: 4px;
            margin-top: 1rem;
        }

        .property-group {
            background-color: #fafafa;
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
        }

        .property-group h4 {
            font-size: 0.95rem;
            margin-bottom: 0.75rem;
            color: var(--secondary-color);
        }

        .array-input {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .array-item {
            display: flex;
            gap: 0.5rem;
        }

        .array-item input {
            flex: 1;
        }

        .array-item button {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
        }

        .add-array-item {
            align-self: flex-start;
        }

        .status-bar {
            background-color: #e8f5e9;
            color: var(--success-color);
            padding: 0.5rem 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }

        .status-bar.error {
            background-color: #ffebee;
            color: var(--error-color);
        }

        .status-bar.warning {
            background-color: #fff3e0;
            color: var(--warning-color);
        }

        .footer {
            text-align: center;
            padding: 1rem;
            color: #666;
            font-size: 0.85rem;
        }

        @media (max-width: 1024px) {
            .container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <h1>Configuration Blender</h1>
        <div class="header-buttons">
            <button class="btn btn-secondary" onclick="importConfig()">Import JSON</button>
            <button class="btn btn-success" onclick="exportConfig()">Export JSON</button>
            <button class="btn btn-primary" onclick="exportSummary()">Export Summary</button>
            <button class="btn btn-info" onclick="showAbout()">About</button>
        </div>
    </header>

    <div class="container">
        <!-- Left Column: Configuration Editor -->
        <div>
            <div class="card">
                <h2>Configuration Info</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label for="configRole">Role</label>
                        <input type="text" id="configRole" placeholder="e.g., US_CBL" onchange="updatePreview()">
                    </div>
                    <div class="form-group">
                        <label for="configVersion">Version</label>
                        <input type="text" id="configVersion" placeholder="e.g., 1.0.0" value="1.0.0" onchange="updatePreview()">
                    </div>
                </div>
                <div class="form-group">
                    <label for="configDescription">Description</label>
                    <input type="text" id="configDescription" placeholder="Configuration description" onchange="updatePreview()">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="configAuthor">Author</label>
                        <input type="text" id="configAuthor" placeholder="Your name" onchange="updatePreview()">
                    </div>
                    <div class="form-group">
                        <label for="configDate">Last Modified</label>
                        <input type="date" id="configDate" onchange="updatePreview()">
                    </div>
                </div>
            </div>

            <div class="card" style="margin-top: 1rem;">
                <h2>Checks</h2>
                <div id="statusBar" class="status-bar" style="display: none;"></div>
                <div class="checks-list" id="checksList">
                    <div style="padding: 2rem; text-align: center; color: #666;">
                        No checks added yet. Click "Add Check" to begin.
                    </div>
                </div>
                <button class="btn btn-primary" onclick="showAddCheckModal()">Add Check</button>
            </div>
        </div>

        <!-- Right Column: JSON Preview -->
        <div>
            <div class="card">
                <h2>JSON Preview</h2>
                <div class="json-preview" id="jsonPreview">
{
  "version": "1.0.0",
  "role": "",
  "description": "",
  "author": "",
  "lastModified": "",
  "checks": []
}
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        Configuration Blender - Developed by Joshua Walderbach, Systems & Infrastructure Engineer III, Windows Engineering OS
    </footer>

    <!-- Add/Edit Check Modal -->
    <div class="modal" id="checkModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="checkModalTitle">Add Check</h3>
                <button class="close-btn" onclick="closeCheckModal()">&times;</button>
            </div>
            <div id="checkModalBody">
                <div class="form-group">
                    <label for="checkType">Check Type</label>
                    <select id="checkType" onchange="showCheckProperties()">
                        <option value="">Select a check type...</option>
                        <option value="ApplicationNotInstalled">Application Not Installed</option>
                        <option value="FolderEmpty">Folder Empty</option>
                        <option value="ShortcutsAllowList">Shortcuts Allow List</option>
                        <option value="FolderHasFiles">Folder Has Files</option>
                        <option value="FilesExist">Files Exist</option>
                        <option value="ShortcutExists">Shortcut Exists</option>
                        <option value="AssignedAccess">Assigned Access</option>
                        <option value="RegistryValue">Registry Value</option>
                        <option value="UserRegistryValue">User Registry Value</option>
                        <option value="ScheduledTaskExists">Scheduled Task Exists</option>
                        <option value="FileContent">File Content</option>
                        <option value="ServiceRunning">Service Running</option>
                        <option value="PrinterInstalled">Printer Installed</option>
                        <option value="DriverInstalled">Driver Installed</option>
                        <option value="WindowsFeature">Windows Feature</option>
                        <option value="FirewallRule">Firewall Rule</option>
                        <option value="CertificateInstalled">Certificate Installed</option>
                        <option value="NetworkAdapterConfiguration">Network Adapter Configuration</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="checkId">Check ID</label>
                        <input type="text" id="checkId" placeholder="e.g., chrome-not-installed">
                    </div>
                    <div class="form-group">
                        <label for="checkName">Display Name</label>
                        <input type="text" id="checkName" placeholder="e.g., Google Chrome Not Installed">
                    </div>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="checkEnabled" checked> Enabled
                    </label>
                </div>
                <div id="checkProperties"></div>
                <div style="margin-top: 1rem;">
                    <button class="btn btn-success" onclick="saveCheck()">Save Check</button>
                    <button class="btn btn-secondary" onclick="closeCheckModal()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- About Modal -->
    <div class="modal" id="aboutModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>About Configuration Blender</h3>
                <button class="close-btn" onclick="closeAbout()">&times;</button>
            </div>
            <div class="about-content">
                <h4>Named in Honor of June Blender</h4>
                <p>
                    June Blender was a Senior Content Developer at Microsoft for PowerShell. She was instrumental
                    in writing documentation and helping users understand PowerShell, including Desired State
                    Configuration (DSC). Her work made PowerShell more accessible to IT professionals and
                    developers worldwide.
                </p>
                <p>
                    This tool continues that mission - making configuration management accessible to engineers
                    regardless of their scripting expertise. By providing a visual interface to define desired
                    system states, Configuration Blender empowers teams to maintain consistent, compliant
                    workstation configurations without requiring deep PowerShell knowledge.
                </p>
                <h4>How It Works</h4>
                <p>
                    1. <strong>Define desired state</strong> - Use this UI to create a JSON configuration file<br>
                    2. <strong>Deploy via Intune</strong> - Package the configuration as a Win32 app<br>
                    3. <strong>Monitor compliance</strong> - Proactive Remediation scripts enforce the configuration<br>
                    4. <strong>Track everything</strong> - All actions are logged for auditing and troubleshooting
                </p>
                <div class="author-info">
                    <strong>Developed by:</strong><br>
                    Joshua Walderbach<br>
                    Systems & Infrastructure Engineer III<br>
                    Windows Engineering OS
                </div>
            </div>
        </div>
    </div>

    <input type="file" id="fileInput" style="display: none;" accept=".json" onchange="handleFileImport(event)">

    <script>
        // Global state
        let checks = [];
        let editingCheckIndex = -1;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('configDate').value = new Date().toISOString().split('T')[0];
            updatePreview();
        });

        // Configuration management
        function getConfig() {
            return {
                version: document.getElementById('configVersion').value || '1.0.0',
                role: document.getElementById('configRole').value || '',
                description: document.getElementById('configDescription').value || '',
                author: document.getElementById('configAuthor').value || '',
                lastModified: document.getElementById('configDate').value || '',
                checks: checks
            };
        }

        function updatePreview() {
            const config = getConfig();
            const preview = document.getElementById('jsonPreview');
            preview.textContent = JSON.stringify(config, null, 2);
        }

        function renderChecksList() {
            const list = document.getElementById('checksList');
            if (checks.length === 0) {
                list.innerHTML = '<div style="padding: 2rem; text-align: center; color: #666;">No checks added yet. Click "Add Check" to begin.</div>';
            } else {
                list.innerHTML = checks.map((check, index) => `
                    <div class="check-item" onclick="editCheck(${index})">
                        <div class="check-info">
                            <div class="check-name">${check.name}</div>
                            <div class="check-type">${check.type} ${!check.enabled ? '(Disabled)' : ''}</div>
                        </div>
                        <div class="check-actions">
                            <button class="btn btn-secondary" onclick="event.stopPropagation(); duplicateCheck(${index})">Copy</button>
                            <button class="btn btn-danger" onclick="event.stopPropagation(); deleteCheck(${index})">Delete</button>
                        </div>
                    </div>
                `).join('');
            }
            updatePreview();
        }

        // Check modal management
        function showAddCheckModal() {
            editingCheckIndex = -1;
            document.getElementById('checkModalTitle').textContent = 'Add Check';
            document.getElementById('checkType').value = '';
            document.getElementById('checkId').value = '';
            document.getElementById('checkName').value = '';
            document.getElementById('checkEnabled').checked = true;
            document.getElementById('checkProperties').innerHTML = '';
            document.getElementById('checkModal').classList.add('active');
        }

        function closeCheckModal() {
            document.getElementById('checkModal').classList.remove('active');
            editingCheckIndex = -1;
        }

        function editCheck(index) {
            editingCheckIndex = index;
            const check = checks[index];
            document.getElementById('checkModalTitle').textContent = 'Edit Check';
            document.getElementById('checkType').value = check.type;
            document.getElementById('checkId').value = check.id;
            document.getElementById('checkName').value = check.name;
            document.getElementById('checkEnabled').checked = check.enabled;
            showCheckProperties();
            populateCheckProperties(check.properties);
            document.getElementById('checkModal').classList.add('active');
        }

        function duplicateCheck(index) {
            const original = checks[index];
            const copy = JSON.parse(JSON.stringify(original));
            copy.id = copy.id + '-copy';
            copy.name = copy.name + ' (Copy)';
            checks.push(copy);
            renderChecksList();
            showStatus('Check duplicated', 'success');
        }

        function deleteCheck(index) {
            if (confirm('Are you sure you want to delete this check?')) {
                checks.splice(index, 1);
                renderChecksList();
                showStatus('Check deleted', 'warning');
            }
        }

        function toggleLprQueue() {
            const portType = document.getElementById('prop_portType').value;
            const lprQueueGroup = document.getElementById('lprQueueGroup');
            if (portType === 'LPR') {
                lprQueueGroup.style.display = 'block';
            } else {
                lprQueueGroup.style.display = 'none';
            }
        }

        function showCheckProperties() {
            const type = document.getElementById('checkType').value;
            const container = document.getElementById('checkProperties');

            if (!type) {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = getPropertiesFormForType(type);
        }

        function getPropertiesFormForType(type) {
            switch (type) {
                case 'ApplicationNotInstalled':
                    return `
                        <div class="property-group">
                            <h4>Application Properties</h4>
                            <div class="form-group">
                                <label>Application Name</label>
                                <input type="text" id="prop_applicationName" placeholder="e.g., Google Chrome">
                            </div>
                            <div class="form-group">
                                <label>Search Paths (one per line)</label>
                                <textarea id="prop_searchPaths" rows="3" placeholder="C:\\Program Files*\\Google\\Chrome\\Application\\chrome.exe"></textarea>
                            </div>
                            <div class="form-group">
                                <label>Uninstall Paths (one per line)</label>
                                <textarea id="prop_uninstallPaths" rows="3" placeholder="C:\\Program Files*\\Google\\Chrome\\Application\\*\\Installer\\setup.exe"></textarea>
                            </div>
                            <div class="form-group">
                                <label>Uninstall Arguments</label>
                                <input type="text" id="prop_uninstallArguments" placeholder="--uninstall --force-uninstall">
                            </div>
                        </div>
                    `;
                case 'FolderEmpty':
                    return `
                        <div class="property-group">
                            <h4>Folder Properties</h4>
                            <div class="form-group">
                                <label>Paths to Clear (one per line)</label>
                                <textarea id="prop_paths" rows="3" placeholder="$env:PUBLIC\\Desktop"></textarea>
                            </div>
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="prop_includeAllUserProfiles"> Include All User Profiles
                                </label>
                            </div>
                        </div>
                    `;
                case 'ShortcutsAllowList':
                    return `
                        <div class="property-group">
                            <h4>Allow List Properties</h4>
                            <div class="form-group">
                                <label>Start Menu Path</label>
                                <input type="text" id="prop_path" value="C:\\ProgramData\\Microsoft\\Windows\\Start Menu\\Programs">
                            </div>
                            <div class="form-group">
                                <label>Allowed Shortcuts (one per line)</label>
                                <textarea id="prop_allowedShortcuts" rows="6" placeholder="GTA Time Clock.lnk"></textarea>
                            </div>
                        </div>
                    `;
                case 'FolderHasFiles':
                    return `
                        <div class="property-group">
                            <h4>Folder Properties</h4>
                            <div class="form-group">
                                <label>Destination Path</label>
                                <input type="text" id="prop_path" placeholder="C:\\ProgramData\\Microsoft\\User Account Pictures">
                            </div>
                            <div class="form-group">
                                <label>Minimum File Count</label>
                                <input type="number" id="prop_minimumFileCount" value="1" min="1">
                            </div>
                            <div class="form-group">
                                <label>Source Asset Path (relative)</label>
                                <input type="text" id="prop_sourceAssetPath" placeholder="AccountPictures">
                                <small style="color: #666;">Relative to Assets folder (do not include "Assets\\")</small>
                            </div>
                        </div>
                    `;
                case 'FilesExist':
                    return `
                        <div class="property-group">
                            <h4>Files Properties</h4>
                            <div class="form-group">
                                <label>Destination Path</label>
                                <input type="text" id="prop_destinationPath" placeholder="C:\\ProgramData\\ConfigurationBlender\\Icons">
                            </div>
                            <div class="form-group">
                                <label>Required Files (one per line)</label>
                                <textarea id="prop_files" rows="6" placeholder="icon1.ico&#10;icon2.ico"></textarea>
                            </div>
                            <div class="form-group">
                                <label>Source Asset Path (relative)</label>
                                <input type="text" id="prop_sourceAssetPath" placeholder="Icons">
                                <small style="color: #666;">Relative to Assets folder (do not include "Assets\\")</small>
                            </div>
                        </div>
                    `;
                case 'ShortcutExists':
                    return `
                        <div class="property-group">
                            <h4>Shortcut Properties</h4>
                            <div class="form-group">
                                <label>Shortcut Path</label>
                                <input type="text" id="prop_path" placeholder="C:\\ProgramData\\...\\Shortcut.lnk">
                            </div>
                            <div class="form-group">
                                <label>Target Path</label>
                                <input type="text" id="prop_targetPath" placeholder="C:\\Program Files\\...\\app.exe">
                            </div>
                            <div class="form-group">
                                <label>Arguments</label>
                                <input type="text" id="prop_arguments" placeholder="--kiosk http://example.com">
                            </div>
                            <div class="form-group">
                                <label>Icon Location</label>
                                <input type="text" id="prop_iconLocation" placeholder="C:\\...\\icon.ico">
                            </div>
                            <div class="form-group">
                                <label>Description</label>
                                <input type="text" id="prop_description" placeholder="Shortcut description">
                            </div>
                        </div>
                    `;
                case 'AssignedAccess':
                    return `
                        <div class="property-group">
                            <h4>Assigned Access Properties</h4>
                            <div class="form-group">
                                <label>Profile ID (GUID)</label>
                                <input type="text" id="prop_profileId" placeholder="{xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx}">
                            </div>
                            <div class="form-group">
                                <label>Display Name</label>
                                <input type="text" id="prop_displayName" placeholder="Kiosk Profile">
                            </div>
                            <div class="form-group">
                                <label>Allowed Apps (one per line)</label>
                                <textarea id="prop_allowedApps" rows="6" placeholder="C:\\Program Files\\...\\app.exe"></textarea>
                            </div>
                            <div class="form-group">
                                <label>Start Pins (one per line)</label>
                                <textarea id="prop_startPins" rows="6" placeholder="%ALLUSERSPROFILE%\\...\\Shortcut.lnk"></textarea>
                            </div>
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="prop_showTaskbar" checked> Show Taskbar
                                </label>
                            </div>
                            <div class="form-group">
                                <label>Allowed Namespaces (one per line)</label>
                                <textarea id="prop_allowedNamespaces" rows="2" placeholder="Downloads"></textarea>
                            </div>
                        </div>
                    `;
                case 'RegistryValue':
                    return `
                        <div class="property-group">
                            <h4>Registry Properties</h4>
                            <div class="form-group">
                                <label>Registry Path</label>
                                <input type="text" id="prop_path" placeholder="HKLM:\\SOFTWARE\\...">
                            </div>
                            <div class="form-group">
                                <label>Value Name</label>
                                <input type="text" id="prop_name" placeholder="ValueName">
                            </div>
                            <div class="form-group">
                                <label>Value</label>
                                <input type="text" id="prop_value" placeholder="1">
                            </div>
                            <div class="form-group">
                                <label>Type</label>
                                <select id="prop_type">
                                    <option value="String">String</option>
                                    <option value="DWord">DWord</option>
                                    <option value="QWord">QWord</option>
                                    <option value="Binary">Binary</option>
                                    <option value="MultiString">MultiString</option>
                                    <option value="ExpandString">ExpandString</option>
                                </select>
                            </div>
                        </div>
                    `;
                case 'UserRegistryValue':
                    return `
                        <div class="property-group">
                            <h4>User Registry Properties</h4>
                            <div class="form-group">
                                <label>Username</label>
                                <input type="text" id="prop_username" placeholder="kioskUser0">
                            </div>
                            <div class="form-group">
                                <label>Registry Path (without HKEY_USERS\\SID)</label>
                                <input type="text" id="prop_path" placeholder="Software\\Microsoft\\...">
                            </div>
                            <div class="form-group">
                                <label>Value Name</label>
                                <input type="text" id="prop_name" placeholder="ValueName">
                            </div>
                            <div class="form-group">
                                <label>Value</label>
                                <input type="text" id="prop_value" placeholder="0">
                            </div>
                            <div class="form-group">
                                <label>Type</label>
                                <select id="prop_type">
                                    <option value="DWord">DWord</option>
                                    <option value="String">String</option>
                                    <option value="QWord">QWord</option>
                                </select>
                            </div>
                        </div>
                    `;
                case 'ScheduledTaskExists':
                    return `
                        <div class="property-group">
                            <h4>Scheduled Task Properties</h4>
                            <div class="form-group">
                                <label>Task Name</label>
                                <input type="text" id="prop_taskName" placeholder="MyTask">
                            </div>
                            <div class="form-group">
                                <label>Task Path</label>
                                <input type="text" id="prop_taskPath" value="\\">
                            </div>
                            <div class="form-group">
                                <label>Execute</label>
                                <input type="text" id="prop_execute" placeholder="Powershell.exe">
                            </div>
                            <div class="form-group">
                                <label>Arguments</label>
                                <input type="text" id="prop_arguments" placeholder="-File C:\\...\\script.ps1">
                            </div>
                            <div class="form-group">
                                <label>Trigger</label>
                                <select id="prop_trigger">
                                    <option value="AtLogOn">At Logon</option>
                                    <option value="AtStartup">At Startup</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Run Level</label>
                                <select id="prop_runLevel">
                                    <option value="Highest">Highest</option>
                                    <option value="Limited">Limited</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Principal</label>
                                <input type="text" id="prop_principal" value="NT AUTHORITY\\SYSTEM">
                            </div>
                        </div>
                    `;
                case 'FileContent':
                    return `
                        <div class="property-group">
                            <h4>File Content Properties</h4>
                            <div class="form-group">
                                <label>Destination Path</label>
                                <input type="text" id="prop_path" placeholder="C:\\...\\script.ps1">
                            </div>
                            <div class="form-group">
                                <label>Source Asset Path (relative)</label>
                                <input type="text" id="prop_sourceAssetPath" placeholder="Scripts\\script.ps1">
                                <small style="color: #666;">Relative to Assets folder (do not include "Assets\\")</small>
                            </div>
                        </div>
                    `;
                case 'ServiceRunning':
                    return `
                        <div class="property-group">
                            <h4>Service Properties</h4>
                            <div class="form-group">
                                <label>Service Name</label>
                                <input type="text" id="prop_serviceName" placeholder="e.g., Spooler">
                            </div>
                            <div class="form-group">
                                <label>Startup Type</label>
                                <select id="prop_startupType">
                                    <option value="Automatic">Automatic</option>
                                    <option value="Manual">Manual</option>
                                    <option value="Disabled">Disabled</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="prop_ensureRunning" checked> Ensure Service is Running
                                </label>
                            </div>
                        </div>
                    `;
                case 'PrinterInstalled':
                    return `
                        <div class="property-group">
                            <h4>Network Printer Properties</h4>
                            <p style="color: #d32f2f; font-size: 0.85rem; margin-bottom: 1rem; padding: 0.5rem; background: #ffebee; border-radius: 4px;">
                                <strong>Important:</strong> The printer driver must be installed BEFORE adding the printer.
                                Use a "Driver Installed" check first to deploy the driver package.
                            </p>
                            <div class="form-group">
                                <label>Printer Name (Required)</label>
                                <input type="text" id="prop_printerName" placeholder="e.g., Office-HP-LaserJet-3F">
                            </div>
                            <div class="form-group">
                                <label>Printer Driver Name (Exact Match Required)</label>
                                <input type="text" id="prop_driverName" placeholder="e.g., HP Universal Printing PCL 6">
                                <small style="color: #666;">Must match the driver name exactly as installed. Run "Get-PrinterDriver" to see installed drivers.</small>
                            </div>
                            <div class="form-group">
                                <label>Printer IP Address or Hostname (Required)</label>
                                <input type="text" id="prop_printerIP" placeholder="e.g., 192.168.1.100 or PRINTER-3F">
                            </div>
                            <div class="form-group">
                                <label>Port Name (Required)</label>
                                <input type="text" id="prop_portName" placeholder="e.g., IP_192.168.1.100 or PRINTER-3F">
                                <small style="color: #666;">Can be IP-based (IP_192.168.1.100) or hostname (PRINTER-3F)</small>
                            </div>
                            <div class="form-group">
                                <label>Port Type</label>
                                <select id="prop_portType" onchange="toggleLprQueue()">
                                    <option value="TCP">TCP/IP Port (Standard)</option>
                                    <option value="LPR">LPR Port</option>
                                </select>
                                <small style="color: #666;">TCP for most network printers, LPR for Unix/Linux print servers</small>
                            </div>
                            <div class="form-group" id="lprQueueGroup" style="display:none;">
                                <label>LPR Queue Name (Required for LPR)</label>
                                <input type="text" id="prop_lprQueue" placeholder="e.g., lp0 or print">
                                <small style="color: #666;">The queue name on the LPR print server</small>
                            </div>
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="prop_setAsDefault"> Set as Default Printer
                                </label>
                            </div>
                        </div>
                    `;
                case 'DriverInstalled':
                    return `
                        <div class="property-group">
                            <h4>Driver Properties</h4>
                            <p style="color: #1565c0; font-size: 0.85rem; margin-bottom: 1rem; padding: 0.5rem; background: #e3f2fd; border-radius: 4px;">
                                <strong>Tip:</strong> Place the complete driver package (.inf + all referenced files) in Assets/Drivers/.
                                For printer drivers, add this check BEFORE the "Printer Installed" check.
                            </p>
                            <div class="form-group">
                                <label>Driver Name</label>
                                <input type="text" id="prop_driverName" placeholder="e.g., HP Universal Printing PCL 6">
                                <small style="color: #666;">Name as it appears after installation (check Device Manager or Get-PrinterDriver)</small>
                            </div>
                            <div class="form-group">
                                <label>Driver Class (Optional)</label>
                                <select id="prop_driverClass">
                                    <option value="">Any Class</option>
                                    <option value="Display">Display</option>
                                    <option value="Net">Network</option>
                                    <option value="AudioEndpoint">Audio</option>
                                    <option value="Printer">Printer</option>
                                    <option value="USB">USB</option>
                                    <option value="System">System</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Source Asset Path (.inf file)</label>
                                <input type="text" id="prop_sourceAssetPath" placeholder="Drivers\\HPUniversal\\hpcu255u.inf">
                                <small style="color: #666;">Path to .inf file. All driver files must be in same folder or subfolders.</small>
                            </div>
                            <div class="form-group">
                                <label>Minimum Version (Optional)</label>
                                <input type="text" id="prop_minimumVersion" placeholder="e.g., 3.0 or 30.0.101.1960">
                                <small style="color: #666;">If specified, driver will be updated if installed version is older</small>
                            </div>
                        </div>
                    `;
                case 'WindowsFeature':
                    return `
                        <div class="property-group">
                            <h4>Windows Feature Properties</h4>
                            <div class="form-group">
                                <label>Feature Name</label>
                                <input type="text" id="prop_featureName" placeholder="e.g., Microsoft-Hyper-V-All">
                                <small style="color: #666;">Use Get-WindowsOptionalFeature -Online to find feature names</small>
                            </div>
                            <div class="form-group">
                                <label>Desired State</label>
                                <select id="prop_state">
                                    <option value="Enabled">Enabled</option>
                                    <option value="Disabled">Disabled</option>
                                </select>
                            </div>
                        </div>
                    `;
                case 'FirewallRule':
                    return `
                        <div class="property-group">
                            <h4>Firewall Rule Properties</h4>
                            <div class="form-group">
                                <label>Rule Name</label>
                                <input type="text" id="prop_ruleName" placeholder="e.g., Block Telemetry">
                            </div>
                            <div class="form-group">
                                <label>Display Name</label>
                                <input type="text" id="prop_displayName" placeholder="e.g., Block Windows Telemetry">
                            </div>
                            <div class="form-group">
                                <label>Direction</label>
                                <select id="prop_direction">
                                    <option value="Inbound">Inbound</option>
                                    <option value="Outbound">Outbound</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Action</label>
                                <select id="prop_action">
                                    <option value="Allow">Allow</option>
                                    <option value="Block">Block</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Protocol (Optional)</label>
                                <select id="prop_protocol">
                                    <option value="">Any</option>
                                    <option value="TCP">TCP</option>
                                    <option value="UDP">UDP</option>
                                    <option value="ICMPv4">ICMPv4</option>
                                    <option value="ICMPv6">ICMPv6</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Remote Address (Optional)</label>
                                <input type="text" id="prop_remoteAddress" placeholder="e.g., 192.168.1.0/24 or telemetry.microsoft.com">
                            </div>
                            <div class="form-group">
                                <label>Remote Port (Optional)</label>
                                <input type="text" id="prop_remotePort" placeholder="e.g., 443 or 80,443">
                            </div>
                            <div class="form-group">
                                <label>Local Port (Optional)</label>
                                <input type="text" id="prop_localPort" placeholder="e.g., 8080">
                            </div>
                            <div class="form-group">
                                <label>Program Path (Optional)</label>
                                <input type="text" id="prop_program" placeholder="e.g., C:\\Program Files\\App\\app.exe">
                            </div>
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="prop_enabled" checked> Rule Enabled
                                </label>
                            </div>
                        </div>
                    `;
                case 'CertificateInstalled':
                    return `
                        <div class="property-group">
                            <h4>Certificate Properties</h4>
                            <div class="form-group">
                                <label>Certificate Store Location</label>
                                <select id="prop_storeLocation">
                                    <option value="LocalMachine">Local Machine</option>
                                    <option value="CurrentUser">Current User</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Certificate Store Name</label>
                                <select id="prop_storeName">
                                    <option value="My">Personal (My)</option>
                                    <option value="Root">Trusted Root CA (Root)</option>
                                    <option value="CA">Intermediate CA (CA)</option>
                                    <option value="TrustedPublisher">Trusted Publishers</option>
                                    <option value="TrustedPeople">Trusted People</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Certificate Thumbprint (Preferred)</label>
                                <input type="text" id="prop_thumbprint" placeholder="e.g., 1A2B3C4D5E6F...">
                                <small style="color: #666;">The unique SHA1 thumbprint of the certificate</small>
                            </div>
                            <div class="form-group">
                                <label>Certificate Subject (Alternative)</label>
                                <input type="text" id="prop_subject" placeholder="e.g., CN=MyCert or *.example.com">
                                <small style="color: #666;">Partial match on certificate subject. Use if thumbprint unknown.</small>
                            </div>
                            <div class="form-group">
                                <label>Expected Issuer (Optional)</label>
                                <input type="text" id="prop_issuer" placeholder="e.g., DigiCert or CN=Enterprise CA">
                                <small style="color: #666;">Verify the certificate was issued by expected CA</small>
                            </div>
                            <div class="form-group">
                                <label>Minimum Days Valid (Optional)</label>
                                <input type="number" id="prop_minimumDaysValid" placeholder="e.g., 30" min="0">
                                <small style="color: #666;">Alert if certificate expires within this many days</small>
                            </div>
                            <div class="form-group">
                                <label>Source Asset Path (for remediation)</label>
                                <input type="text" id="prop_sourceAssetPath" placeholder="Certificates\\MyCert.cer">
                                <small style="color: #666;">Relative to Assets folder. Supports .cer, .crt, .pfx, .p12</small>
                            </div>
                            <div class="form-group">
                                <label>PFX Password (if .pfx/.p12)</label>
                                <input type="password" id="prop_pfxPassword" placeholder="Password for PFX file">
                                <small style="color: #666; color: #d32f2f;">Warning: Stored in plain text in Config.json</small>
                            </div>
                        </div>
                    `;
                case 'NetworkAdapterConfiguration':
                    return `
                        <div class="property-group">
                            <h4>Adapter Identification (choose one)</h4>
                            <div class="form-group">
                                <label>Adapter Name</label>
                                <input type="text" id="prop_adapterName" placeholder="e.g., Ethernet 2">
                                <small style="color: #666;">Exact name as shown in Network Connections</small>
                            </div>
                            <div class="form-group">
                                <label>Adapter Description (Alternative)</label>
                                <input type="text" id="prop_adapterDescription" placeholder="e.g., Intel(R) I211 Gigabit">
                                <small style="color: #666;">Partial match on hardware description</small>
                            </div>
                            <div class="form-group">
                                <label>MAC Address (Alternative)</label>
                                <input type="text" id="prop_macAddress" placeholder="e.g., 00:1A:2B:3C:4D:5E or 00-1A-2B-3C-4D-5E">
                                <small style="color: #666;">Physical address of the adapter</small>
                            </div>
                        </div>
                        <div class="property-group">
                            <h4>IP Configuration</h4>
                            <div class="form-group">
                                <label>Static IP Address</label>
                                <input type="text" id="prop_staticIPAddress" placeholder="e.g., 192.168.1.100">
                                <small style="color: #666;">Leave empty to keep DHCP</small>
                            </div>
                            <div class="form-group">
                                <label>Subnet Prefix Length</label>
                                <input type="number" id="prop_subnetPrefixLength" placeholder="e.g., 24" min="1" max="32">
                                <small style="color: #666;">24 = 255.255.255.0, 16 = 255.255.0.0</small>
                            </div>
                            <div class="form-group">
                                <label>Default Gateway</label>
                                <input type="text" id="prop_defaultGateway" placeholder="e.g., 192.168.1.1">
                            </div>
                            <div class="form-group">
                                <label>DNS Servers (one per line)</label>
                                <textarea id="prop_dnsServers" rows="2" placeholder="8.8.8.8&#10;8.8.4.4"></textarea>
                            </div>
                        </div>
                        <div class="property-group">
                            <h4>Network Profile & Settings</h4>
                            <div class="form-group">
                                <label>Network Category</label>
                                <select id="prop_networkCategory">
                                    <option value="">Do not change</option>
                                    <option value="Private">Private</option>
                                    <option value="Public">Public</option>
                                </select>
                                <small style="color: #666;">Private enables network discovery; Public is more secure</small>
                            </div>
                            <div class="form-group">
                                <label>Interface Metric (Priority)</label>
                                <input type="number" id="prop_interfaceMetric" placeholder="e.g., 10" min="1">
                                <small style="color: #666;">Lower = higher priority. Use to prefer one adapter over another.</small>
                            </div>
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="prop_ensureEnabled" checked> Ensure Adapter is Enabled
                                </label>
                            </div>
                        </div>
                    `;
                default:
                    return '<p>Select a check type to see properties.</p>';
            }
        }

        function populateCheckProperties(properties) {
            if (!properties) return;

            for (const [key, value] of Object.entries(properties)) {
                const element = document.getElementById('prop_' + key);
                if (element) {
                    if (element.type === 'checkbox') {
                        element.checked = value;
                    } else if (element.tagName === 'TEXTAREA' && Array.isArray(value)) {
                        element.value = value.join('\n');
                    } else {
                        element.value = value;
                    }
                }
            }

            // Handle conditional field visibility for PrinterInstalled
            const portTypeElement = document.getElementById('prop_portType');
            if (portTypeElement) {
                toggleLprQueue();
            }
        }

        function getCheckProperties() {
            const type = document.getElementById('checkType').value;
            const properties = {};

            switch (type) {
                case 'ApplicationNotInstalled':
                    properties.applicationName = document.getElementById('prop_applicationName').value;
                    properties.searchPaths = document.getElementById('prop_searchPaths').value.split('\n').filter(p => p.trim());
                    properties.uninstallPaths = document.getElementById('prop_uninstallPaths').value.split('\n').filter(p => p.trim());
                    properties.uninstallArguments = document.getElementById('prop_uninstallArguments').value;
                    break;
                case 'FolderEmpty':
                    properties.paths = document.getElementById('prop_paths').value.split('\n').filter(p => p.trim());
                    properties.includeAllUserProfiles = document.getElementById('prop_includeAllUserProfiles').checked;
                    break;
                case 'ShortcutsAllowList':
                    properties.path = document.getElementById('prop_path').value;
                    properties.allowedShortcuts = document.getElementById('prop_allowedShortcuts').value.split('\n').filter(p => p.trim());
                    break;
                case 'FolderHasFiles':
                    properties.path = document.getElementById('prop_path').value;
                    properties.minimumFileCount = parseInt(document.getElementById('prop_minimumFileCount').value) || 1;
                    properties.sourceAssetPath = document.getElementById('prop_sourceAssetPath').value;
                    break;
                case 'FilesExist':
                    properties.destinationPath = document.getElementById('prop_destinationPath').value;
                    properties.files = document.getElementById('prop_files').value.split('\n').filter(p => p.trim());
                    properties.sourceAssetPath = document.getElementById('prop_sourceAssetPath').value;
                    break;
                case 'ShortcutExists':
                    properties.path = document.getElementById('prop_path').value;
                    properties.targetPath = document.getElementById('prop_targetPath').value;
                    properties.arguments = document.getElementById('prop_arguments').value;
                    properties.iconLocation = document.getElementById('prop_iconLocation').value;
                    properties.description = document.getElementById('prop_description').value;
                    break;
                case 'AssignedAccess':
                    properties.profileId = document.getElementById('prop_profileId').value;
                    properties.displayName = document.getElementById('prop_displayName').value;
                    properties.allowedApps = document.getElementById('prop_allowedApps').value.split('\n').filter(p => p.trim());
                    properties.startPins = document.getElementById('prop_startPins').value.split('\n').filter(p => p.trim());
                    properties.showTaskbar = document.getElementById('prop_showTaskbar').checked;
                    properties.allowedNamespaces = document.getElementById('prop_allowedNamespaces').value.split('\n').filter(p => p.trim());
                    break;
                case 'RegistryValue':
                    properties.path = document.getElementById('prop_path').value;
                    properties.name = document.getElementById('prop_name').value;
                    const regValue = document.getElementById('prop_value').value;
                    const regType = document.getElementById('prop_type').value;
                    properties.value = (regType === 'DWord' || regType === 'QWord') ? parseInt(regValue) : regValue;
                    properties.type = regType;
                    break;
                case 'UserRegistryValue':
                    properties.username = document.getElementById('prop_username').value;
                    properties.path = document.getElementById('prop_path').value;
                    properties.name = document.getElementById('prop_name').value;
                    const userRegValue = document.getElementById('prop_value').value;
                    const userRegType = document.getElementById('prop_type').value;
                    properties.value = (userRegType === 'DWord' || userRegType === 'QWord') ? parseInt(userRegValue) : userRegValue;
                    properties.type = userRegType;
                    break;
                case 'ScheduledTaskExists':
                    properties.taskName = document.getElementById('prop_taskName').value;
                    properties.taskPath = document.getElementById('prop_taskPath').value;
                    properties.execute = document.getElementById('prop_execute').value;
                    properties.arguments = document.getElementById('prop_arguments').value;
                    properties.trigger = document.getElementById('prop_trigger').value;
                    properties.runLevel = document.getElementById('prop_runLevel').value;
                    properties.principal = document.getElementById('prop_principal').value;
                    break;
                case 'FileContent':
                    properties.path = document.getElementById('prop_path').value;
                    properties.sourceAssetPath = document.getElementById('prop_sourceAssetPath').value;
                    break;
                case 'ServiceRunning':
                    properties.serviceName = document.getElementById('prop_serviceName').value;
                    properties.startupType = document.getElementById('prop_startupType').value;
                    properties.ensureRunning = document.getElementById('prop_ensureRunning').checked;
                    break;
                case 'PrinterInstalled':
                    properties.printerName = document.getElementById('prop_printerName').value;
                    properties.driverName = document.getElementById('prop_driverName').value;
                    properties.portName = document.getElementById('prop_portName').value;
                    properties.printerIP = document.getElementById('prop_printerIP').value;
                    properties.portType = document.getElementById('prop_portType').value;
                    const lprQueueValue = document.getElementById('prop_lprQueue').value;
                    if (lprQueueValue) {
                        properties.lprQueue = lprQueueValue;
                    }
                    properties.setAsDefault = document.getElementById('prop_setAsDefault').checked;
                    break;
                case 'DriverInstalled':
                    properties.driverName = document.getElementById('prop_driverName').value;
                    properties.driverClass = document.getElementById('prop_driverClass').value;
                    properties.sourceAssetPath = document.getElementById('prop_sourceAssetPath').value;
                    properties.minimumVersion = document.getElementById('prop_minimumVersion').value;
                    break;
                case 'WindowsFeature':
                    properties.featureName = document.getElementById('prop_featureName').value;
                    properties.state = document.getElementById('prop_state').value;
                    break;
                case 'FirewallRule':
                    properties.ruleName = document.getElementById('prop_ruleName').value;
                    properties.displayName = document.getElementById('prop_displayName').value;
                    properties.direction = document.getElementById('prop_direction').value;
                    properties.action = document.getElementById('prop_action').value;
                    properties.protocol = document.getElementById('prop_protocol').value;
                    properties.remoteAddress = document.getElementById('prop_remoteAddress').value;
                    properties.remotePort = document.getElementById('prop_remotePort').value;
                    properties.localPort = document.getElementById('prop_localPort').value;
                    properties.program = document.getElementById('prop_program').value;
                    properties.enabled = document.getElementById('prop_enabled').checked;
                    break;
                case 'CertificateInstalled':
                    properties.storeLocation = document.getElementById('prop_storeLocation').value;
                    properties.storeName = document.getElementById('prop_storeName').value;
                    const thumbprint = document.getElementById('prop_thumbprint').value;
                    if (thumbprint) properties.thumbprint = thumbprint;
                    const subject = document.getElementById('prop_subject').value;
                    if (subject) properties.subject = subject;
                    const issuer = document.getElementById('prop_issuer').value;
                    if (issuer) properties.issuer = issuer;
                    const minDays = document.getElementById('prop_minimumDaysValid').value;
                    if (minDays) properties.minimumDaysValid = parseInt(minDays);
                    const certSourcePath = document.getElementById('prop_sourceAssetPath').value;
                    if (certSourcePath) properties.sourceAssetPath = certSourcePath;
                    const pfxPass = document.getElementById('prop_pfxPassword').value;
                    if (pfxPass) properties.pfxPassword = pfxPass;
                    break;
                case 'NetworkAdapterConfiguration':
                    const adapterName = document.getElementById('prop_adapterName').value;
                    if (adapterName) properties.adapterName = adapterName;
                    const adapterDesc = document.getElementById('prop_adapterDescription').value;
                    if (adapterDesc) properties.adapterDescription = adapterDesc;
                    const macAddr = document.getElementById('prop_macAddress').value;
                    if (macAddr) properties.macAddress = macAddr;
                    const staticIP = document.getElementById('prop_staticIPAddress').value;
                    if (staticIP) properties.staticIPAddress = staticIP;
                    const prefixLen = document.getElementById('prop_subnetPrefixLength').value;
                    if (prefixLen) properties.subnetPrefixLength = parseInt(prefixLen);
                    const gateway = document.getElementById('prop_defaultGateway').value;
                    if (gateway) properties.defaultGateway = gateway;
                    const dnsText = document.getElementById('prop_dnsServers').value;
                    if (dnsText) properties.dnsServers = dnsText.split('\n').filter(d => d.trim());
                    const netCategory = document.getElementById('prop_networkCategory').value;
                    if (netCategory) properties.networkCategory = netCategory;
                    const metric = document.getElementById('prop_interfaceMetric').value;
                    if (metric) properties.interfaceMetric = parseInt(metric);
                    properties.ensureEnabled = document.getElementById('prop_ensureEnabled').checked;
                    break;
            }

            return properties;
        }

        function saveCheck() {
            const type = document.getElementById('checkType').value;
            const id = document.getElementById('checkId').value;
            const name = document.getElementById('checkName').value;
            const enabled = document.getElementById('checkEnabled').checked;

            if (!type || !id || !name) {
                showStatus('Please fill in all required fields (Type, ID, Name)', 'error');
                return;
            }

            const check = {
                id: id,
                name: name,
                type: type,
                enabled: enabled,
                properties: getCheckProperties()
            };

            if (editingCheckIndex >= 0) {
                checks[editingCheckIndex] = check;
                showStatus('Check updated successfully', 'success');
            } else {
                checks.push(check);
                showStatus('Check added successfully', 'success');
            }

            closeCheckModal();
            renderChecksList();
        }

        // Import/Export
        function importConfig() {
            document.getElementById('fileInput').click();
        }

        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const config = JSON.parse(e.target.result);
                    document.getElementById('configVersion').value = config.version || '1.0.0';
                    document.getElementById('configRole').value = config.role || '';
                    document.getElementById('configDescription').value = config.description || '';
                    document.getElementById('configAuthor').value = config.author || '';
                    document.getElementById('configDate').value = config.lastModified || '';
                    checks = config.checks || [];
                    renderChecksList();
                    showStatus('Configuration imported successfully', 'success');
                } catch (err) {
                    showStatus('Failed to parse JSON file: ' + err.message, 'error');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function doExportConfig() {
            const config = getConfig();
            const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'Config.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            // Show reminder about file placement
            const role = config.role || '[ROLE]';
            alert(`Config.json exported successfully!\n\nMove this file to:\nConfigurations\\${role}\\Config.json\n\nPlace any assets in:\nConfigurations\\${role}\\Assets\\`);
        }

        // About modal
        function showAbout() {
            document.getElementById('aboutModal').classList.add('active');
        }

        function closeAbout() {
            document.getElementById('aboutModal').classList.remove('active');
        }

        // Status messages
        function showStatus(message, type = 'success') {
            const statusBar = document.getElementById('statusBar');
            statusBar.textContent = message;
            statusBar.className = 'status-bar';
            if (type === 'error') statusBar.classList.add('error');
            if (type === 'warning') statusBar.classList.add('warning');
            statusBar.style.display = 'block';
            setTimeout(() => {
                statusBar.style.display = 'none';
            }, 3000);
        }

        // ============================================================================
        // REAL-TIME VALIDATION
        // ============================================================================

        function validateConfiguration() {
            const warnings = [];
            const errors = [];

            // Check for duplicate IDs
            const ids = checks.map(c => c.id);
            const duplicateIds = ids.filter((id, index) => ids.indexOf(id) !== index);
            if (duplicateIds.length > 0) {
                errors.push(`Duplicate check IDs found: ${[...new Set(duplicateIds)].join(', ')}`);
            }

            // Validate each check
            checks.forEach((check, index) => {
                // Check for HKCU usage in RegistryValue (SYSTEM context issue)
                if (check.type === 'RegistryValue' && check.properties.path && check.properties.path.includes('HKCU:')) {
                    warnings.push(`Check "${check.name}": Using HKCU:\\ in RegistryValue will modify SYSTEM's registry, not the user's. Consider using UserRegistryValue instead.`);
                }

                // Check for empty required fields
                if (!check.id || !check.name) {
                    errors.push(`Check #${index + 1}: Missing required ID or name`);
                }

                // Type-specific validations
                switch (check.type) {
                    case 'PrinterInstalled':
                        if (!check.properties.printerName || !check.properties.driverName || !check.properties.printerIP || !check.properties.portName) {
                            errors.push(`Check "${check.name}": PrinterInstalled requires printerName, driverName, printerIP, and portName`);
                        }
                        if (check.properties.portType === 'LPR' && !check.properties.lprQueue) {
                            errors.push(`Check "${check.name}": LPR port type requires lprQueue property`);
                        }
                        break;
                    case 'UserRegistryValue':
                        if (!check.properties.username) {
                            errors.push(`Check "${check.name}": UserRegistryValue requires username`);
                        }
                        break;
                    case 'FilesExist':
                    case 'FolderHasFiles':
                    case 'FileContent':
                    case 'DriverInstalled':
                        if (check.properties.sourceAssetPath && check.properties.sourceAssetPath.startsWith('Assets')) {
                            warnings.push(`Check "${check.name}": Asset path should NOT start with "Assets\\" - it's already relative to the Assets folder`);
                        }
                        break;
                    case 'CertificateInstalled':
                        if (!check.properties.thumbprint && !check.properties.subject) {
                            errors.push(`Check "${check.name}": CertificateInstalled requires either thumbprint or subject`);
                        }
                        if (check.properties.sourceAssetPath && check.properties.sourceAssetPath.startsWith('Assets')) {
                            warnings.push(`Check "${check.name}": Asset path should NOT start with "Assets\\" - it's already relative to the Assets folder`);
                        }
                        if (check.properties.pfxPassword) {
                            warnings.push(`Check "${check.name}": PFX password is stored in plain text in Config.json - consider security implications`);
                        }
                        break;
                    case 'NetworkAdapterConfiguration':
                        if (!check.properties.adapterName && !check.properties.adapterDescription && !check.properties.macAddress) {
                            errors.push(`Check "${check.name}": NetworkAdapterConfiguration requires adapterName, adapterDescription, or macAddress`);
                        }
                        if (check.properties.staticIPAddress && !check.properties.subnetPrefixLength) {
                            warnings.push(`Check "${check.name}": Static IP configured without subnet prefix length (will default to /24)`);
                        }
                        break;
                }
            });

            return { errors, warnings };
        }

        function showValidationResults() {
            const { errors, warnings } = validateConfiguration();
            const statusBar = document.getElementById('statusBar');

            if (errors.length > 0) {
                statusBar.innerHTML = '<strong> Errors:</strong><br>' + errors.map(e => ` ${e}`).join('<br>');
                statusBar.className = 'status-bar error';
                statusBar.style.display = 'block';
                return false;
            } else if (warnings.length > 0) {
                statusBar.innerHTML = '<strong> Warnings:</strong><br>' + warnings.map(w => ` ${w}`).join('<br>');
                statusBar.className = 'status-bar warning';
                statusBar.style.display = 'block';
                return true;
            } else {
                statusBar.innerHTML = ' Configuration looks good!';
                statusBar.className = 'status-bar';
                statusBar.style.display = 'block';
                setTimeout(() => {
                    statusBar.style.display = 'none';
                }, 3000);
                return true;
            }
        }

        // Validate when checks change
        function renderChecksList() {
            const list = document.getElementById('checksList');
            if (checks.length === 0) {
                list.innerHTML = '<div style="padding: 2rem; text-align: center; color: #666;">No checks added yet. Click "Add Check" to begin.</div>';
            } else {
                list.innerHTML = checks.map((check, index) => `
                    <div class="check-item" onclick="editCheck(${index})">
                        <div class="check-info">
                            <div class="check-name">${check.name}</div>
                            <div class="check-type">${check.type} ${!check.enabled ? '(Disabled)' : ''}</div>
                        </div>
                        <div class="check-actions">
                            <button class="btn btn-secondary" onclick="event.stopPropagation(); duplicateCheck(${index})">Copy</button>
                            <button class="btn btn-danger" onclick="event.stopPropagation(); deleteCheck(${index})">Delete</button>
                        </div>
                    </div>
                `).join('');
            }
            updatePreview();

            // Run validation automatically
            if (checks.length > 0) {
                showValidationResults();
            }
        }

        // Export with validation
        function exportConfig() {
            const { errors } = validateConfiguration();
            if (errors.length > 0) {
                showValidationResults();
                if (!confirm('Configuration has errors. Export anyway?')) {
                    return;
                }
            }
            doExportConfig();
        }

        // ============================================================================
        // SUMMARY EXPORT
        // ============================================================================

        const checkTypeIcons = {
            'ApplicationNotInstalled': '',
            'ApplicationInstalled': '',
            'FolderEmpty': '',
            'FolderHasFiles': '',
            'FilesExist': '',
            'ShortcutsAllowList': '',
            'ShortcutExists': '',
            'AssignedAccess': '',
            'RegistryValue': '',
            'UserRegistryValue': '',
            'ScheduledTaskExists': '',
            'FileContent': '',
            'ServiceRunning': '',
            'PrinterInstalled': '',
            'DriverInstalled': '',
            'WindowsFeature': '',
            'FirewallRule': '',
            'CertificateInstalled': '',
            'NetworkAdapterConfiguration': ''
        };

        function generateCheckSummary(check, index) {
            const icon = checkTypeIcons[check.type] || '';
            const props = check.properties;
            let md = `### ${index + 1}. ${icon} ${check.name}\n`;
            md += `**Type:** \`${check.type}\`  \n`;
            md += `**ID:** \`${check.id}\`  \n`;
            md += `**Enabled:** ${check.enabled ? 'Yes' : 'No'}\n\n`;

            // Type-specific details
            switch (check.type) {
                case 'ApplicationNotInstalled':
                    md += generateAppNotInstalledSummary(props);
                    break;
                case 'ApplicationInstalled':
                    md += generateAppInstalledSummary(props);
                    break;
                case 'FolderEmpty':
                    md += generateFolderEmptySummary(props);
                    break;
                case 'FolderHasFiles':
                    md += generateFolderHasFilesSummary(props);
                    break;
                case 'FilesExist':
                    md += generateFilesExistSummary(props);
                    break;
                case 'ShortcutsAllowList':
                    md += generateShortcutsAllowListSummary(props);
                    break;
                case 'ShortcutExists':
                    md += generateShortcutExistsSummary(props);
                    break;
                case 'AssignedAccess':
                    md += generateAssignedAccessSummary(props);
                    break;
                case 'RegistryValue':
                    md += generateRegistryValueSummary(props);
                    break;
                case 'UserRegistryValue':
                    md += generateUserRegistryValueSummary(props);
                    break;
                case 'ScheduledTaskExists':
                    md += generateScheduledTaskSummary(props);
                    break;
                case 'FileContent':
                    md += generateFileContentSummary(props);
                    break;
                case 'ServiceRunning':
                    md += generateServiceRunningSummary(props);
                    break;
                case 'PrinterInstalled':
                    md += generatePrinterInstalledSummary(props);
                    break;
                case 'DriverInstalled':
                    md += generateDriverInstalledSummary(props);
                    break;
                case 'WindowsFeature':
                    md += generateWindowsFeatureSummary(props);
                    break;
                case 'FirewallRule':
                    md += generateFirewallRuleSummary(props);
                    break;
                case 'CertificateInstalled':
                    md += generateCertificateInstalledSummary(props);
                    break;
                case 'NetworkAdapterConfiguration':
                    md += generateNetworkAdapterSummary(props);
                    break;
                default:
                    md += `**Properties:**\n\`\`\`json\n${JSON.stringify(props, null, 2)}\n\`\`\`\n`;
            }

            md += '\n---\n\n';
            return md;
        }

        function generateAppNotInstalledSummary(props) {
            let md = '```mermaid\nflowchart LR\n';
            md += `    A[Search for ${props.applicationName}] --> B{Found?}\n`;
            md += '    B -->|No| C[ Pass]\n';
            md += '    B -->|Yes| D[Run Uninstaller]\n';
            md += '    D --> E[ Removed]\n';
            md += '```\n\n';

            md += '**Detection:**\n';
            md += 'Searches for application in:\n';
            (props.searchPaths || []).forEach(p => {
                md += `- \`${p}\`\n`;
            });

            md += '\n**Remediation:**\n';
            md += 'Runs uninstaller from:\n';
            (props.uninstallPaths || []).forEach(p => {
                md += `- \`${p}\`\n`;
            });
            if (props.uninstallArguments) {
                md += `\nArguments: \`${props.uninstallArguments}\`\n`;
            }
            return md;
        }

        function generateAppInstalledSummary(props) {
            let md = '```mermaid\nflowchart LR\n';
            md += `    A[Check for ${props.applicationName}] --> B{Installed?}\n`;
            md += '    B -->|Yes| C[ Pass]\n';
            md += '    B -->|No| D[Run Installer]\n';
            md += '    D --> E[ Installed]\n';
            md += '```\n\n';

            md += '**Detection:**\n';
            md += `- Application: \`${props.applicationName}\`\n`;
            if (props.detectionPath) md += `- Detection Path: \`${props.detectionPath}\`\n`;
            if (props.minimumVersion) md += `- Minimum Version: \`${props.minimumVersion}\`\n`;

            md += '\n**Remediation:**\n';
            if (props.installCommand) md += `- Install Command: \`${props.installCommand}\`\n`;
            return md;
        }

        function generateFolderEmptySummary(props) {
            let md = '```mermaid\nflowchart LR\n';
            md += '    A[Check Folders] --> B{Empty?}\n';
            md += '    B -->|Yes| C[ Pass]\n';
            md += '    B -->|No| D[Delete Contents]\n';
            md += '    D --> E[ Cleared]\n';
            md += '```\n\n';

            md += '**Detection:**\n';
            md += 'Checks if these folders are empty:\n';
            (props.paths || []).forEach(p => {
                md += `- \`${p}\`\n`;
            });
            if (props.includeAllUserProfiles) {
                md += '\n*Also checks all user profile folders*\n';
            }

            md += '\n**Remediation:**\n';
            md += 'Deletes all files and subfolders from the listed paths.\n';
            return md;
        }

        function generateFolderHasFilesSummary(props) {
            let md = '```mermaid\nflowchart LR\n';
            md += `    A[Check ${props.path}] --> B{Has ${props.minimumFileCount || 1}+ files?}\n`;
            md += '    B -->|Yes| C[ Pass]\n';
            md += '    B -->|No| D[Copy from Assets]\n';
            md += '    D --> E[ Files Present]\n';
            md += '```\n\n';

            md += '**Detection:**\n';
            md += `- Path: \`${props.path}\`\n`;
            md += `- Minimum Files Required: ${props.minimumFileCount || 1}\n`;

            md += '\n**Remediation:**\n';
            md += `- Copies files from: \`Assets\\${props.sourceAssetPath}\`\n`;
            return md;
        }

        function generateFilesExistSummary(props) {
            let md = '**Detection:**\n';
            md += `Checks if these files exist in \`${props.destinationPath}\`:\n\n`;
            md += '| File | Status |\n|------|--------|\n';
            (props.files || []).forEach(f => {
                md += `| \`${f}\` | Required |\n`;
            });

            md += '\n**Remediation:**\n';
            md += `Copies missing files from \`Assets\\${props.sourceAssetPath}\`\n`;
            return md;
        }

        function generateShortcutsAllowListSummary(props) {
            let md = '**Detection:**\n';
            md += `Scans \`${props.path}\` for shortcuts.\n\n`;
            md += '**Allowed Shortcuts:**\n';
            md += '| Shortcut | Status |\n|----------|--------|\n';
            (props.allowedShortcuts || []).forEach(s => {
                md += `| ${s} |  Allowed |\n`;
            });

            md += '\n**Remediation:**\n';
            md += 'Deletes any shortcuts NOT in the allowed list.\n';
            return md;
        }

        function generateShortcutExistsSummary(props) {
            // Extract URL from arguments if Edge kiosk
            let target = props.targetPath;
            let url = '';
            if (props.arguments && props.arguments.includes('--kiosk')) {
                const match = props.arguments.match(/--kiosk\s+(https?:\/\/[^\s]+)/);
                if (match) url = match[1];
            }

            let md = '```mermaid\nflowchart LR\n';
            if (url) {
                md += `    A[ ${props.description || 'Shortcut'}] --> B[Edge Kiosk]\n`;
                md += `    B --> C[${url}]\n`;
            } else {
                md += `    A[ ${props.description || 'Shortcut'}] --> B[${target.split('\\\\').pop()}]\n`;
            }
            md += '```\n\n';

            md += '**Shortcut Details:**\n';
            md += `| Property | Value |\n|----------|-------|\n`;
            md += `| Path | \`${props.path}\` |\n`;
            md += `| Target | \`${props.targetPath}\` |\n`;
            if (props.arguments) md += `| Arguments | \`${props.arguments}\` |\n`;
            if (props.iconLocation) md += `| Icon | \`${props.iconLocation}\` |\n`;
            if (props.description) md += `| Description | ${props.description} |\n`;

            md += '\n**Remediation:**\n';
            md += 'Creates or updates the shortcut with the specified properties.\n';
            return md;
        }

        function generateAssignedAccessSummary(props) {
            let md = '```mermaid\nflowchart TD\n';
            md += '    subgraph Kiosk[" ' + (props.displayName || 'Kiosk') + '"]\n';
            md += '        subgraph Apps["Allowed Applications"]\n';
            (props.allowedApps || []).forEach((app, i) => {
                const appName = app.split('\\\\').pop().replace('.exe', '').replace('.EXE', '');
                md += `            A${i}[${appName}]\n`;
            });
            md += '        end\n';
            md += '        subgraph Pins["Start Menu Pins"]\n';
            (props.startPins || []).slice(0, 5).forEach((pin, i) => {
                const pinName = pin.split('\\\\').pop().replace('.lnk', '');
                md += `            P${i}[${pinName}]\n`;
            });
            if ((props.startPins || []).length > 5) {
                md += `            P99[...and ${props.startPins.length - 5} more]\n`;
            }
            md += '        end\n';
            md += '    end\n';
            md += '```\n\n';

            md += '**Configuration:**\n';
            md += `| Property | Value |\n|----------|-------|\n`;
            md += `| Profile ID | \`${props.profileId}\` |\n`;
            md += `| Display Name | ${props.displayName} |\n`;
            md += `| Show Taskbar | ${props.showTaskbar ? 'Yes' : 'No'} |\n`;

            md += '\n**Allowed Applications:**\n';
            (props.allowedApps || []).forEach(app => {
                md += `- \`${app}\`\n`;
            });

            md += '\n**Start Menu Pins:**\n';
            (props.startPins || []).forEach(pin => {
                md += `- \`${pin}\`\n`;
            });

            md += '\n**Remediation:**\n';
            md += 'Applies Assigned Access XML configuration via WMI MDM_AssignedAccess class.\n';
            md += '\n *Requires SYSTEM privileges*\n';
            return md;
        }

        function generateRegistryValueSummary(props) {
            let md = '```mermaid\nflowchart LR\n';
            const keyName = props.path.split('\\\\').pop();
            md += `    A[ ${keyName}] --> B[${props.name}]\n`;
            md += `    B --> C["${props.value}"]\n`;
            md += '```\n\n';

            md += '**Registry Details:**\n';
            md += `| Property | Value |\n|----------|-------|\n`;
            md += `| Path | \`${props.path}\` |\n`;
            md += `| Name | \`${props.name}\` |\n`;
            md += `| Value | \`${props.value}\` |\n`;
            md += `| Type | ${props.type || 'String'} |\n`;

            md += '\n**Remediation:**\n';
            md += 'Creates the registry key (if missing) and sets the value.\n';
            return md;
        }

        function generateUserRegistryValueSummary(props) {
            let md = '```mermaid\nflowchart LR\n';
            md += `    A[ ${props.username}] --> B[Load Hive]\n`;
            md += `    B --> C[${props.name} = "${props.value}"]\n`;
            md += '```\n\n';

            md += '**User Registry Details:**\n';
            md += `| Property | Value |\n|----------|-------|\n`;
            md += `| Username | \`${props.username}\` |\n`;
            md += `| Path | \`${props.path}\` |\n`;
            md += `| Name | \`${props.name}\` |\n`;
            md += `| Value | \`${props.value}\` |\n`;
            md += `| Type | ${props.type || 'String'} |\n`;

            md += '\n**Remediation:**\n';
            md += `Loads the user's registry hive (NTUSER.DAT) and sets the value.\n`;
            return md;
        }

        function generateScheduledTaskSummary(props) {
            let md = '```mermaid\nflowchart LR\n';
            md += `    A[ ${props.taskName}] --> B{Trigger: ${props.trigger || 'Manual'}}\n`;
            md += `    B --> C[Run: ${props.execute.split('\\\\').pop()}]\n`;
            if (props.principal) md += `    C --> D[As: ${props.principal}]\n`;
            md += '```\n\n';

            md += '**Task Details:**\n';
            md += `| Property | Value |\n|----------|-------|\n`;
            md += `| Task Name | \`${props.taskName}\` |\n`;
            md += `| Task Path | \`${props.taskPath || '\\\\'}\` |\n`;
            md += `| Execute | \`${props.execute}\` |\n`;
            if (props.arguments) md += `| Arguments | \`${props.arguments}\` |\n`;
            md += `| Trigger | ${props.trigger || 'Manual'} |\n`;
            if (props.runLevel) md += `| Run Level | ${props.runLevel} |\n`;
            if (props.principal) md += `| Principal | \`${props.principal}\` |\n`;

            md += '\n**Remediation:**\n';
            md += 'Creates the scheduled task with specified trigger and action.\n';
            return md;
        }

        function generateFileContentSummary(props) {
            let md = '```mermaid\nflowchart LR\n';
            const fileName = props.path.split('\\\\').pop();
            md += `    A[Assets/${props.sourceAssetPath}] -->|Copy| B[${fileName}]\n`;
            md += '```\n\n';

            md += '**File Details:**\n';
            md += `| Property | Value |\n|----------|-------|\n`;
            md += `| Destination | \`${props.path}\` |\n`;
            md += `| Source | \`Assets\\${props.sourceAssetPath}\` |\n`;

            md += '\n**Remediation:**\n';
            md += 'Copies the file from Assets to the destination path.\n';
            return md;
        }

        function generateServiceRunningSummary(props) {
            let md = '```mermaid\nflowchart LR\n';
            md += `    A[ ${props.serviceName}] --> B{Running?}\n`;
            md += '    B -->|Yes| C[ Pass]\n';
            md += '    B -->|No| D[Start Service]\n';
            md += '    D --> E[ Running]\n';
            md += '```\n\n';

            md += '**Service Details:**\n';
            md += `| Property | Value |\n|----------|-------|\n`;
            md += `| Service Name | \`${props.serviceName}\` |\n`;
            if (props.startupType) md += `| Startup Type | ${props.startupType} |\n`;
            md += `| Ensure Running | ${props.ensureRunning !== false ? 'Yes' : 'No'} |\n`;

            md += '\n**Remediation:**\n';
            md += 'Sets startup type and starts the service if not running.\n';
            return md;
        }

        function generatePrinterInstalledSummary(props) {
            let md = '```mermaid\nflowchart LR\n';
            md += `    A[ ${props.printerName}] --> B[${props.printerIP}]\n`;
            md += `    B --> C[Port: ${props.portName}]\n`;
            md += `    C --> D[Driver: ${props.driverName}]\n`;
            md += '```\n\n';

            md += '**Printer Details:**\n';
            md += `| Property | Value |\n|----------|-------|\n`;
            md += `| Printer Name | \`${props.printerName}\` |\n`;
            md += `| Driver | \`${props.driverName}\` |\n`;
            md += `| IP/Hostname | \`${props.printerIP}\` |\n`;
            md += `| Port Name | \`${props.portName}\` |\n`;
            md += `| Port Type | ${props.portType || 'TCP'} |\n`;
            if (props.lprQueue) md += `| LPR Queue | \`${props.lprQueue}\` |\n`;
            md += `| Set as Default | ${props.setAsDefault ? 'Yes' : 'No'} |\n`;

            md += '\n**Remediation:**\n';
            md += 'Creates printer port (if missing) and adds printer with specified driver.\n';
            md += '\n *Driver must be installed before printer can be added*\n';
            return md;
        }

        function generateDriverInstalledSummary(props) {
            let md = '```mermaid\nflowchart LR\n';
            md += `    A[ ${props.driverName}] --> B{Installed?}\n`;
            md += '    B -->|Yes| C{Version OK?}\n';
            md += '    B -->|No| D[Install Driver]\n';
            md += '    C -->|Yes| E[ Pass]\n';
            md += '    C -->|No| F[Update Driver]\n';
            md += '    D --> E\n';
            md += '    F --> E\n';
            md += '```\n\n';

            md += '**Driver Details:**\n';
            md += `| Property | Value |\n|----------|-------|\n`;
            md += `| Driver Name | \`${props.driverName}\` |\n`;
            if (props.driverClass) md += `| Driver Class | ${props.driverClass} |\n`;
            if (props.sourceAssetPath) md += `| Source | \`Assets\\${props.sourceAssetPath}\` |\n`;
            if (props.minimumVersion) md += `| Minimum Version | ${props.minimumVersion} |\n`;

            md += '\n**Remediation:**\n';
            md += 'Installs driver using `pnputil /add-driver /install`\n';
            if (props.minimumVersion) {
                md += 'If version is too old, removes existing driver first.\n';
            }
            return md;
        }

        function generateWindowsFeatureSummary(props) {
            const enabling = props.state === 'Enabled';
            let md = '```mermaid\nflowchart LR\n';
            md += `    A[ ${props.featureName}] --> B{${enabling ? 'Enabled' : 'Disabled'}?}\n`;
            md += '    B -->|Yes| C[ Pass]\n';
            md += `    B -->|No| D[${enabling ? 'Enable' : 'Disable'} Feature]\n`;
            md += '    D --> E[ Done]\n';
            md += '```\n\n';

            md += '**Feature Details:**\n';
            md += `| Property | Value |\n|----------|-------|\n`;
            md += `| Feature Name | \`${props.featureName}\` |\n`;
            md += `| Desired State | ${props.state} |\n`;

            md += '\n**Remediation:**\n';
            md += `${enabling ? 'Enables' : 'Disables'} the Windows optional feature.\n`;
            md += '\n *May require reboot*\n';
            return md;
        }

        function generateFirewallRuleSummary(props) {
            let md = '```mermaid\nflowchart LR\n';
            const direction = props.direction === 'Inbound' ? '' : '';
            md += `    A[${props.direction === 'Inbound' ? 'Internet' : 'Local'}] --${direction}--> B[ ${props.displayName}]\n`;
            md += `    B --${props.action === 'Allow' ? '' : ''}--> C[${props.direction === 'Inbound' ? 'Local' : 'Internet'}]\n`;
            md += '```\n\n';

            md += '**Firewall Rule Details:**\n';
            md += `| Property | Value |\n|----------|-------|\n`;
            md += `| Rule Name | \`${props.ruleName}\` |\n`;
            md += `| Display Name | ${props.displayName} |\n`;
            md += `| Direction | ${props.direction} |\n`;
            md += `| Action | ${props.action} |\n`;
            if (props.protocol) md += `| Protocol | ${props.protocol} |\n`;
            if (props.remoteAddress) md += `| Remote Address | \`${props.remoteAddress}\` |\n`;
            if (props.remotePort) md += `| Remote Port | ${props.remotePort} |\n`;
            if (props.localPort) md += `| Local Port | ${props.localPort} |\n`;
            if (props.program) md += `| Program | \`${props.program}\` |\n`;
            md += `| Enabled | ${props.enabled !== false ? 'Yes' : 'No'} |\n`;

            md += '\n**Remediation:**\n';
            md += 'Creates or updates the Windows Firewall rule.\n';
            return md;
        }

        function generateCertificateInstalledSummary(props) {
            let md = '```mermaid\nflowchart LR\n';
            md += `    A[ Certificate] --> B[${props.storeLocation || 'LocalMachine'}]\n`;
            md += `    B --> C[${props.storeName || 'My'}]\n`;
            if (props.thumbprint) {
                md += `    C --> D[Thumbprint: ${props.thumbprint.substring(0, 8)}...]\n`;
            } else if (props.subject) {
                md += `    C --> D[Subject: ${props.subject}]\n`;
            }
            md += '```\n\n';

            md += '**Certificate Details:**\n';
            md += `| Property | Value |\n|----------|-------|\n`;
            md += `| Store Location | ${props.storeLocation || 'LocalMachine'} |\n`;
            md += `| Store Name | ${props.storeName || 'My'} |\n`;
            if (props.thumbprint) md += `| Thumbprint | \`${props.thumbprint}\` |\n`;
            if (props.subject) md += `| Subject | \`${props.subject}\` |\n`;
            if (props.issuer) md += `| Expected Issuer | \`${props.issuer}\` |\n`;
            if (props.minimumDaysValid) md += `| Min Days Valid | ${props.minimumDaysValid} |\n`;
            if (props.sourceAssetPath) md += `| Source | \`Assets\\${props.sourceAssetPath}\` |\n`;

            md += '\n**Remediation:**\n';
            if (props.sourceAssetPath) {
                md += `Imports certificate from \`Assets\\${props.sourceAssetPath}\`\n`;
            } else {
                md += 'No remediation available (no source certificate specified).\n';
            }
            if (props.minimumDaysValid) {
                md += `\n *Alerts if certificate expires within ${props.minimumDaysValid} days*\n`;
            }
            return md;
        }

        function generateNetworkAdapterSummary(props) {
            let md = '```mermaid\nflowchart TD\n';
            const adapterLabel = props.adapterName || props.adapterDescription || props.macAddress || 'Adapter';
            md += `    A[ ${adapterLabel}]\n`;
            if (props.staticIPAddress) {
                md += `    A --> B[IP: ${props.staticIPAddress}/${props.subnetPrefixLength || 24}]\n`;
                if (props.defaultGateway) md += `    B --> C[Gateway: ${props.defaultGateway}]\n`;
            }
            if (props.dnsServers && props.dnsServers.length > 0) {
                md += `    A --> D[DNS: ${props.dnsServers.join(', ')}]\n`;
            }
            if (props.networkCategory) {
                md += `    A --> E[Category: ${props.networkCategory}]\n`;
            }
            if (props.interfaceMetric) {
                md += `    A --> F[Metric: ${props.interfaceMetric}]\n`;
            }
            md += '```\n\n';

            md += '**Adapter Identification:**\n';
            md += `| Property | Value |\n|----------|-------|\n`;
            if (props.adapterName) md += `| Adapter Name | \`${props.adapterName}\` |\n`;
            if (props.adapterDescription) md += `| Description | \`${props.adapterDescription}\` |\n`;
            if (props.macAddress) md += `| MAC Address | \`${props.macAddress}\` |\n`;

            md += '\n**IP Configuration:**\n';
            md += `| Property | Value |\n|----------|-------|\n`;
            if (props.staticIPAddress) {
                md += `| Static IP | \`${props.staticIPAddress}\` |\n`;
                md += `| Subnet Prefix | /${props.subnetPrefixLength || 24} |\n`;
            } else {
                md += `| DHCP | Enabled |\n`;
            }
            if (props.defaultGateway) md += `| Gateway | \`${props.defaultGateway}\` |\n`;
            if (props.dnsServers) md += `| DNS Servers | ${props.dnsServers.map(d => '\`' + d + '\`').join(', ')} |\n`;
            if (props.networkCategory) md += `| Network Category | ${props.networkCategory} |\n`;
            if (props.interfaceMetric) md += `| Interface Metric | ${props.interfaceMetric} |\n`;
            md += `| Ensure Enabled | ${props.ensureEnabled !== false ? 'Yes' : 'No'} |\n`;

            md += '\n**Remediation:**\n';
            md += 'Configures adapter with specified IP settings, DNS, and network category.\n';
            return md;
        }

        function generateSummaryMarkdown() {
            const config = getConfig();
            const checks = config.checks || [];

            // Count checks by type
            const typeCounts = {};
            checks.forEach(c => {
                typeCounts[c.type] = (typeCounts[c.type] || 0) + 1;
            });

            let md = `# ${config.role || 'Configuration'} Summary\n\n`;

            // Overview section
            md += '## Overview\n\n';
            md += '| Property | Value |\n|----------|-------|\n';
            md += `| Role | ${config.role || 'Not specified'} |\n`;
            md += `| Version | ${config.version || 'Not specified'} |\n`;
            md += `| Description | ${config.description || 'Not specified'} |\n`;
            md += `| Author | ${config.author || 'Not specified'} |\n`;
            md += `| Last Modified | ${config.lastModified || 'Not specified'} |\n`;
            md += `| Total Checks | ${checks.length} |\n`;
            md += '\n';

            // Process flow diagram
            md += '## Process Flow\n\n';
            md += '```mermaid\nflowchart TD\n';
            md += '    A[Intune Proactive Remediation] --> B[Detect.ps1]\n';
            md += '    B --> C{All Checks Pass?}\n';
            md += '    C -->|Yes| D[Exit 0 - Compliant]\n';
            md += '    C -->|No| E[Exit 1 - Non-Compliant]\n';
            md += '    E --> F[Remediate.ps1]\n';
            md += '    F --> G[Fix Failed Checks]\n';
            md += '    G --> H[Log Results]\n';
            md += '```\n\n';

            // Checks by type
            md += '## Checks by Type\n\n';
            md += '| Type | Count | Icon |\n|------|-------|------|\n';
            Object.keys(typeCounts).sort().forEach(type => {
                md += `| ${type} | ${typeCounts[type]} | ${checkTypeIcons[type] || ''} |\n`;
            });
            md += '\n';

            // Dependencies section
            md += '## Dependencies & Execution Order\n\n';
            md += 'Checks are processed in the order listed below. Notable dependencies:\n\n';

            // Find driver/printer dependencies
            const driverChecks = checks.filter(c => c.type === 'DriverInstalled');
            const printerChecks = checks.filter(c => c.type === 'PrinterInstalled');
            if (driverChecks.length > 0 && printerChecks.length > 0) {
                md += '- **Driver  Printer:** Printer drivers must be installed before printers can be added\n';
            }

            // Find script/task dependencies
            const scriptChecks = checks.filter(c => c.type === 'FileContent');
            const taskChecks = checks.filter(c => c.type === 'ScheduledTaskExists');
            if (scriptChecks.length > 0 && taskChecks.length > 0) {
                md += '- **Script  Task:** Script files should exist before scheduled tasks reference them\n';
            }

            // Find icon/shortcut dependencies
            const iconChecks = checks.filter(c => c.type === 'FilesExist' && c.properties.sourceAssetPath && c.properties.sourceAssetPath.toLowerCase().includes('icon'));
            const shortcutChecks = checks.filter(c => c.type === 'ShortcutExists');
            if (iconChecks.length > 0 && shortcutChecks.length > 0) {
                md += '- **Icons  Shortcuts:** Icon files should exist before shortcuts reference them\n';
            }

            md += '\n---\n\n';

            // Individual check details
            md += '## Check Details\n\n';
            checks.forEach((check, index) => {
                md += generateCheckSummary(check, index);
            });

            // Footer
            md += '---\n\n';
            md += `*Generated by Configuration Blender on ${new Date().toISOString().split('T')[0]}*\n`;

            return md;
        }

        function exportSummary() {
            const config = getConfig();
            if (!config.checks || config.checks.length === 0) {
                alert('No checks to export. Add at least one check first.');
                return;
            }

            const markdown = generateSummaryMarkdown();
            const blob = new Blob([markdown], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const role = config.role || 'Config';
            a.download = `${role}_Summary.md`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            alert(`${role}_Summary.md exported successfully!\n\nThis markdown file contains visual diagrams that render on GitHub.`);
        }

        // Only close About modal on outside click (not the check editor)
        window.onclick = (event) => {
            if (event.target.id === 'aboutModal') {
                event.target.classList.remove('active');
            }
        };
    </script>
</body>
</html>
